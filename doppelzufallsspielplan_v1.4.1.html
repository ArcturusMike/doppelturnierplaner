<!--
Änderung gegenüber v1.4.0: Beide Funktionen wurden so gut es ging "teilvereint" -> Vereinfachung; Schnelle Anzeige ob gleich viele Spiele pro Spieler
-->

<!DOCTYPE html>
<html>
<head>
    <title>Spielplangenerator Doppelturnier</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            background-color: rgba(0, 89, 255, 0.3);
        }
        
        #eingabediv, input, button {
            font-size: 14pt;
        }

        #spielplantabelle {
            border-collapse: collapse;
        }

        .tabelleninput {
            font-size: 12pt;
            padding: 0px;
        }

        #drucken {
            float: right;
        }

        th, td {
            text-align: center;
            padding: 5px;
        }

        #spielplantabelle th, #spielplantabelle td {
            min-width: 150px;
        }

        #auswertungstabelle th, #auswertungstabelle td {
            padding-left: 30px;
            padding-right: 30px;
        }

        #version {
            position: fixed;
            right: 5px;
            bottom: 5px;
            font-size: 9pt;
            text-align: right;
        }

        #eingabediv, #tabellendiv {
            float: left;
        }

        #eingabediv {
            max-width: 40%;
            margin-right: 100px;
        }

        #spieleanzahl {
            margin-top: 50px;
        }

        .spiele_pro_spieler {
            tab-size: 10;
            font-family: sans-serif;
            font-size: 14pt;
            margin: 0;
        }

        .spiele_analyse {
            color: white; 
            font-size: 14pt; 
            padding: 5px; 
            border-radius: 10px;
        }

        #spiele_gleich {
            background-color: green; 
        }

        #spiele_nicht_gleich {
            background-color: red;
        }

        #tipps {
            border-radius: 10px;
            padding: 10px;
            background-color: white;
            font-size: 12pt;
        }

        li {
            padding-bottom: 15px;
        }

        .tabhead {
            background-color: darkslategray;
            color: white;
        }

        input[type="text"], input[type="number"] {
            width: 10em;
        }

        #mixed {
            width: 12pt;
            height: 12pt;
        }

        button, #eingabediv input[type="text"], #eingabediv input[type="number"] {
            border: 1px solid grey;
            border-radius: 5px;
            padding: 5px;
        }

        button:hover {
            cursor: pointer;
        }
    </style>
</head>
<body>    
<script>
    function findPartner(player, str) { // von ChatGPT
        // Create an array of teams by splitting the string with " - " as the delimiter
        const teams = str.split(" - ");

        // Find the team that contains the player and split it into its individual players
        const players = teams.find(team => team.includes(player)).split("/");

        // Find the partner of the player in each team and return them as an array
        return players.filter(p => p !== player);
    }

    function findOpponents(player, str) { // von ChatGPT
        // Create an array of teams by splitting the string with " - " as the delimiter
        const teams = str.split(" - ");

        // Find the team that contains the player and split it into its individual players
        const players = teams.find(team => team.includes(player)).split("/");

        // Find the opponents of the player in each team and return them as an array
        const opponents = teams.filter(team => !team.includes(player)).map(team => team.split("/")).reduce((acc, cur) => acc.concat(cur), []);

        return opponents.filter(p => !players.includes(p));
    }

    // manche der später benötigten Variablen werden schon hier definiert
    var anzahl_runden, anzahl_spiele_pro_runde, doppelkombinationen,   hintergrundfarbe, n, next_player_1, next_player_2, next_player_3, next_player_4, plaetze, spieler_spiele_anzahl_array, spieler_spiele_anzahl_array_herren, spieler_spiele_anzahl_array_damen, spielplan, spielplan_rest, spielplan_string, tabellenzeilen;

    var alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
    for (i=26; i>0; i--) { 
        eval("var spieler" + i + ";");
        eval("var partner_spieler" + i+ ";");
        eval("var gegner_spieler" + i + ";");
        eval("var anzahl_spiele_spieler" + i + ";");
        eval("var runde" + i + ";"); // 26 Runden weil eher nicht mehr als 26 benötigt werden
    }

    function spiele_generieren() {
        var SA = doppelkombinationen.slice();
        var m = doppelkombinationen.length;
        if (m < 0) { // Sinnvoll? Ist m < 0 möglich?
            m *= -1;
        }
        if (m % 2 != 0) {
            m++;
            SA.push("Platzhalter");
        }
        var HA = SA.slice();
        spielplan = [];
        for (i=0; i<=(m-2); i++) {
            var a = 0;
            var b = m - 1;
            for (c=1; c<=(m/2); c++) {
                spielplan.push(SA[a] + " - " + SA[b]);
                a++;
                b--;
            }
            SA[1] = HA[m-1];
            x = 2;
            for (y=1; y<=(m-1); y++) {
                SA[x] = HA[y];
                x++;
            }
            HA = SA.slice();
        }
    }

    function zufaellig_sortieren(objekt) {
        // Array 5 Mal zufällig sortieren nach Fisher-Yates-Shuffle
        for (i=0; i<5; i++) {
            var sl = objekt.length;
            while (--sl > 0) {
                var randIndex = Math.floor(Math.random() * (sl + 1));
                [objekt[randIndex], objekt[sl]] = [objekt[sl], objekt[randIndex]];
            }
        }
    }

    function inputs_deaktivieren(anzahl) {
        document.getElementById("erstellen_button").disabled = true;
        for (i=1; i<=anzahl; i++) {
            eval("document.getElementById('spieler" + i + "').disabled = true");
        }
    }

    function spiele_wieder_array() {
        // den String wieder zum Array machen, nur dass diesmal die Namen drin stehen statt den Anfangszahlen
        spielplan = spielplan_string.split("\n");
    }

    function rundenvorbereitung(art) {
        spielplan_rest = spielplan.slice();

        console.clear()

        anzahl_spiele_pro_runde = plaetze;
        tabellenzeilen = "";

        // Je ein Array für alle Runden erstellen
        anzahl_runden = document.getElementById("eingabe_runden").value;

        if (art == "zusammen") {
            // für das allererste Spiel das spieler_spiele_anzahl_array definieren
            spieler_spiele_anzahl_array = [];
            for (i=n; i>0; i--) {
                // das Array wird neu zusammengebaut; weil von hinten nach vorne wird "unshift" verwendet
                eval("spieler_spiele_anzahl_array.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }

            zufaellig_sortieren(spieler_spiele_anzahl_array);

            console.log("Diese Spieler werden für das allererste Spiel einbezogen: ");
            console.log(spieler_spiele_anzahl_array);
        }
        else if (art == "mixed") {
            // für Herren & Damen eigene Spielerarrays
            // für das allererste Spiel die spieler_spiele_anzahl_arrays definieren
            spieler_spiele_anzahl_array_herren = [];
            spieler_spiele_anzahl_array_damen = [];
            for (i=n; i>0; i--) {
                eval("spieler_spiele_anzahl_array_herren.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }
            for (i=(2*n); i>n; i--) {
                eval("spieler_spiele_anzahl_array_damen.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }

            zufaellig_sortieren(spieler_spiele_anzahl_array_herren);
            zufaellig_sortieren(spieler_spiele_anzahl_array_damen);

            console.log("Diese Spieler werden für das allererste Spiel einbezogen: ");
            console.log(spieler_spiele_anzahl_array_herren);
            console.log(spieler_spiele_anzahl_array_damen);
        }
    }

    function tabelle_hintergrundfarbe() {
        if (r % 2) {
            hintergrundfarbe = "lightgray";
        }
        else {
            hintergrundfarbe = "white";
        }
    }

    function spieler_bestimmen(art) {
        if (art == "zusammen") {
            // die Spieler für das nächste Spiel werden festgelegt
            if (x == 1) { // wenn allererstes Spiel der Runde:
                next_player_1 = spieler_spiele_anzahl_array[0].spieler;
                next_player_2 = spieler_spiele_anzahl_array[1].spieler;
                next_player_3 = spieler_spiele_anzahl_array[2].spieler;
                next_player_4 = spieler_spiele_anzahl_array[3].spieler;
            }
            else { // wenn eines der nachfolgenden Spiele der Runde:
                for(z=1, y=0; z<=4; z++) {
                    eval("next_player_" + z + " = spieler_spiele_anzahl_array[" + y + "].spieler;");
                
                    // Ein Spieler soll nicht 2 Mal pro Runde spielen:
                    eval("var aktuelle_rundenlaenge = runde" + r + ".length");
                    for (w=0; w<aktuelle_rundenlaenge; w++) { // jedes Spiel der Runde durchgehen
                        do {  // so lange pro Spielersuche nach doppelten Auftritten, bis der doppelte Auftritt beseitigt ist (do...while)
                            //console.log("Runde " + r + " Spiel " + (w+1) + " wird auf " + eval("next_player_" + z) + " kontrolliert; np_" + z);
                            if (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")")) {
                                eval("var spieler_alt = next_player_" + z);
                                y++;
                                eval("var next_player_" + z + " = spieler_spiele_anzahl_array[" + y + "].spieler;");
                                eval("var spieler_neu = next_player_" + z);
                                console.log('%c       Spieler ' + spieler_alt + ' --> ' + spieler_neu + '       ', 'background-color: yellow; color: black');
                                
                                w = 0;    // damit er nach der Neuzuweisung wieder alle Spiele der Runde von vorne kontrolliert
                                //console.log('%c        Es geht bei Spiel Nr. ' + (w+1) + ' weiter, es soll Spieler ' + spieler_neu + ' kontrolliert werden           ', 'background-color: yellow; color: black');
                                
                            }
                        }
                        while (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")"));
                    }
                    y++;
                }
            }    
        }
        else if (art == "mixed") {
            // die Spieler für das nächste Spiel werden festgelegt
            if (x == 1) { // wenn allererstes Spiel der Runde:
                next_player_1 = spieler_spiele_anzahl_array_herren[0].spieler;
                next_player_2 = spieler_spiele_anzahl_array_herren[1].spieler;
                next_player_3 = spieler_spiele_anzahl_array_damen[0].spieler;
                next_player_4 = spieler_spiele_anzahl_array_damen[1].spieler;
            }
            else { // wenn eines der nachfolgenden Spiele der Runde:
                // die Herren-Spieler für das nächste Spiel werden festgelegt
                for(z=1, y=0; z<=2; z++) {
                    eval("next_player_" + z + " = spieler_spiele_anzahl_array_herren[" + y + "].spieler;");
                    
                    eval("var aktuelle_rundenlaenge = runde" + r + ".length");
                    for (w=0; w<aktuelle_rundenlaenge; w++) {
                        do {  // so lange pro Spielersuche nach doppelten Auftritten suchen, bis der doppelte Auftritt beseitigt ist (do...while)
                            //console.log("H - Runde " + r + " Spiel " + (w+1) + " wird auf " + eval("next_player_" + z) + " kontrolliert; np_" + z);
                            if (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")")) {
                                eval("var spieler_alt = next_player_" + z);
                                y++;
                                eval("var next_player_" + z + " = spieler_spiele_anzahl_array_herren[" + y + "].spieler;");
                                eval("var spieler_neu = next_player_" + z);
                                console.log('%c                Spieler ' + spieler_alt + ' --> ' + spieler_neu + '                   ', 'background-color: yellow; color: black');
                                w = 0;    // damit er nach der Neuzuweisung wieder alle Spiele der Runde von vorne kontrolliert
                                //console.log('%c        Es geht bei Spiel Nr. ' + (w+1) + ' weiter, es soll Spieler ' + spieler_neu + ' kontrolliert werden           ', 'background-color: yellow; color: black');
                            }
                        }
                        while (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")"));
                    }
                    y++;
                }
                // die Damen-Spieler für das nächste Spiel werden festgelegt
                for(z=3, y=0; z<=4; z++) {
                    eval("next_player_" + z + " = spieler_spiele_anzahl_array_damen[" + y + "].spieler;");
                    
                    eval("var aktuelle_rundenlaenge = runde" + r + ".length");
                    for (w=0; w<aktuelle_rundenlaenge; w++) {
                        do {  // so lange pro Spielersuche nach doppelten Auftritten suchen, bis der doppelte Auftritt beseitigt ist (do...while)
                            //console.log("D - Runde " + r + " Spiel " + (w+1) + " wird auf " + eval("next_player_" + z) + " kontrolliert; np_" + z);
                            if (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")")) {
                                eval("var spieler_alt = next_player_" + z);
                                y++;
                                eval("var next_player_" + z + " = spieler_spiele_anzahl_array_damen[" + y + "].spieler;");
                                eval("var spieler_neu = next_player_" + z);
                                console.log('%c                Spieler ' + spieler_alt + ' --> ' + spieler_neu + '                   ', 'background-color: yellow; color: black');
                                w = 0;    // damit er nach der Neuzuweisung wieder alle Spiele der Runde von vorne kontrolliert
                                //console.log('%c        Es geht bei Spiel Nr. ' + (w+1) + ' weiter, es soll Spieler ' + spieler_neu + ' kontrolliert werden           ', 'background-color: yellow; color: black');
                            }
                        }
                        while (eval("runde" + r + "[" + w + "].includes(next_player_" + z + ")"));
                    }
                    y++
                }
            }
        }
        console.log("Nächste Spieler: " + next_player_1 + " " + next_player_2 + " " + next_player_3 + " " + next_player_4);
    }

    function passendes_spiel_finden_und_speichern(anzahl) {
        // das passende Spiel im restlichen Spielplan finden, in dem die 4 Spieler mit den wenigsten Spielen vorkommen und auf Partner kontrollieren
        var continueOuterLoop = false; // mithilfe von ChatGPT gelöst
        for (u=0; u<spielplan_rest.length; u++) {
            if (spielplan_rest[u].includes(next_player_1) && spielplan_rest[u].includes(next_player_2) && spielplan_rest[u].includes(next_player_3) && spielplan_rest[u].includes(next_player_4)) { // wenn das Spiel alle Spieler enthält
                console.log("Spielvorschlag: " + spielplan_rest[u] + " (Matchindex " + u + " von " + spielplan_rest.length + ")");
                if (x > 1 || r > 1) { // immer außer beim allerersten Spiel auf Partner prüfen, da es dort noch keine gibt
                    OuterLoop: for (t=1; t<=4; t++) { // alle Spieler des Spiels durchgehen
                        eval("var aktueller_partner_spieler" + t + "= findPartner(next_player_" + t + ", spielplan_rest[u]).toString();")
                        console.log("Partner von " + eval("next_player_" + t) + ": " + eval("aktueller_partner_spieler" + t));

                        for (p=anzahl; p>0; p--) { // das richtige partner_spieler-Array finden für next_player
                            if (eval("document.getElementById('spieler" + p + "').value == next_player_" + t)) {
                                if (eval("partner_spieler" + p + ".includes(aktueller_partner_spieler" + t + ")")) { // wenn der Partner bereits vorkommt
                                    console.log('%c     Partner von ' + eval("next_player_" + t) + ' kommt bereits vor: ' + eval("partner_spieler" + p) + '     ', 'background-color: orange; color: black');
                                    continueOuterLoop = true;
                                    break OuterLoop; // damit nicht alle Partner/Spieler angezeigt werden, sobald einer schon vorkommt
                                }  
                            }
                        }
                    }
                }
                var next_match = spielplan_rest[u];
                // wenn der Partner schon existiert, ist continueOuterLoop true, also ist das !continueOuterLoop falsch, d.h. es wird NICHT gebreakt
                // wenn der Partner zum ersten Mal da ist, ist continueOuterLoop falsch, also wird gebreakt
                if (!continueOuterLoop) {
                    break; 
                }
                
                else {
                    continueOuterLoop = false;
                }
            }
        }

        eval("runde" + r + ".push(next_match)");
        var next_match_index = spielplan_rest.indexOf(next_match);
        spielplan_rest.splice(next_match_index, 1);
        
        console.log("Nächstes Match: " + next_match);
        console.log("Rundenspielplan: " + eval("runde" + r));

        tabellenzeilen += "<tr style='background-color: " + hintergrundfarbe + "' class=''><td>Runde " + r + "</td><td>Platz " + x + "</td><td>" + eval("runde" + r + "[x-1]") + "</td><td><input style='border: 0px; text-align: center; background-color: " + hintergrundfarbe + "' class='tabelleninput' type='text'></td></tr>";
    }

    function vorheriges_spiel_auswerten(art, anzahl) {
        // Spieler des letzten Spieles bestimmen, deren Spielanzahl um 1 erhöhen und alle Spieler samt deren Spielanzahl in ein Objekt-Array packen
        spieler_spiele_anzahl_array = [];
        spieler_spiele_anzahl_array_herren = [];
        spieler_spiele_anzahl_array_damen = [];

        for (i=anzahl; i>0; i--) {
            // wenn das letzte Spiel in der bestimmten Runde spieleri enthält, dann erhöhe anzahl_spiele_spieleri um 1 und finde dessen Partner+Gegner heraus
            if (eval("runde" + r + "[runde" + r + ".length-1].includes(spieler" + i + ")")) {
                eval("anzahl_spiele_spieler" + i + "++;");
                eval("partner_spieler" + i + " = partner_spieler" + i + ".concat(findPartner(spieler" + i + ",runde" + r + "[runde" + r + ".length-1]))");
                //console.log("Jetziger Partner von " + eval("spieler" + i) + ": " + findPartner(eval("spieler" + i), eval("runde" + r + "[runde" + r + ".length-1]")));
                //console.log(eval("partner_spieler" + i));
                eval("gegner_spieler" + i + ".push(findOpponents(spieler" + i + ",runde" + r + "[runde" + r + ".length-1]).join('/'))");
                //console.log("Jetzige Gegner von " + eval("spieler" + i) + ": " + findOpponents(eval("spieler" + i), eval("runde" + r + "[runde" + r + ".length-1]")));
                //console.log(eval("gegner_spieler" + i));
            }
        }

        if (art == "zusammen") {
            // das Array wird neu zusammengebaut; weil von hinten nach vorne wird "unshift" verwendet
            for (i=n; i>0; i--) {
                eval("spieler_spiele_anzahl_array.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }

            // das Array der Spieler mit den jeweiligen Anzahlen der Spielen wird nach der Spielanzahl sortiert (damit später die Paarungen mit den wenigsten Spielen gefunden werden können)
            spieler_spiele_anzahl_array.sort(function(obj1, obj2) {
                return obj1.anzahl_spiele - obj2.anzahl_spiele;
            });

            // das Array wird in kleinere Arrays mit denselben Spielanzahlen gesplittet, damit diese zufällig sortiert werden. Sie werden zum Schluss wieder zu einem einzigen Array zusammengeführt. Sinn: Es ist nicht alphabetisch.
            ssaa_gemischt = [];
            for (p=0; p<=r; p++) {
                eval("var ssaa" + p + " = spieler_spiele_anzahl_array.filter(splitten)");

                function splitten(element) {
                    return element.anzahl_spiele == p;
                };

                // 5 Mal nach Fisher-Yates shufflen
                for (q=0; q<5; q++) {
                    var sl = eval("ssaa" + p + ".length");
                    while (--sl > 0) {
                        var randIndex = Math.floor(Math.random() * (sl + 1));
                        eval("[ssaa" + p + "[randIndex], ssaa" + p + "[sl]] = [ssaa" + p + "[sl], ssaa" + p + "[randIndex]];");
                    }
                }
                
                eval("ssaa_gemischt = ssaa_gemischt.concat(ssaa" + p + ");");
            }
            spieler_spiele_anzahl_array = ssaa_gemischt.slice();

            console.log("Anzahl der Spiele pro Spieler nach Rundenende: ");
            console.log(spieler_spiele_anzahl_array);
            console.log(" \n \n \n");
        }
        else if (art == "mixed") {
            // das Array wird neu zusammengebaut; weil von hinten nach vorne wird "unshift" verwendet; für Herren & Damen eigene Spielerarrays
            for (i=n; i>0; i--) {
                eval("spieler_spiele_anzahl_array_herren.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }
            for (i=(2*n); i>n; i--) {
                eval("spieler_spiele_anzahl_array_damen.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            }

            // das Array der Spieler mit den jeweiligen Anzahlen der Spielen wird nach der Spielanzahl sortiert (damit später die Paarungen mit den wenigsten Spielen gefunden werden können)
            spieler_spiele_anzahl_array_herren.sort(function(obj1, obj2) {
                return obj1.anzahl_spiele - obj2.anzahl_spiele;
            });
            spieler_spiele_anzahl_array_damen.sort(function(obj1, obj2) {
                return obj1.anzahl_spiele - obj2.anzahl_spiele;
            });

            // das Array wird in kleinere Arrays mit den selben  Spielanzahlen gesplittet, damit diese zufällig sortiert werden. Sie werden zum Schluss wieder zu einem einzigen Array zusammengeführt. Sinn: Es ist nicht unbedingt alphabetisch
            ssaa_herren_gemischt = [];
            for (p=0; p<=r; p++) {
                eval("var ssaa_herren" + p + " = spieler_spiele_anzahl_array_herren.filter(splitten)");

                function splitten(element) {
                    return element.anzahl_spiele == p;
                };

                // 5 Mal nach Fisher-Yates shufflen
                for (q=0; q<5; q++) {
                    var sl = eval("ssaa_herren" + p + ".length");
                    while (--sl > 0) {
                        var randIndex = Math.floor(Math.random() * (sl + 1));
                        eval("[ssaa_herren" + p + "[randIndex], ssaa_herren" + p + "[sl]] = [ssaa_herren" + p + "[sl], ssaa_herren" + p + "[randIndex]];");
                    }
                }

                eval("ssaa_herren_gemischt = ssaa_herren_gemischt.concat(ssaa_herren" + p + ");");
            }
            spieler_spiele_anzahl_array_herren = ssaa_herren_gemischt.slice();

            // und für die Damen auch
            ssaa_damen_gemischt = [];
            for (p=0; p<=r; p++) {
                eval("var ssaa_damen" + p + " = spieler_spiele_anzahl_array_damen.filter(splitten)");

                function splitten(element) {
                    return element.anzahl_spiele == p;
                };

                // 5 Mal nach Fisher-Yates shufflen
                for (q=0; q<5; q++) {
                    var sl = eval("ssaa_damen" + p + ".length");
                    while (--sl > 0) {
                        var randIndex = Math.floor(Math.random() * (sl + 1));
                        eval("[ssaa_damen" + p + "[randIndex], ssaa_damen" + p + "[sl]] = [ssaa_damen" + p + "[sl], ssaa_damen" + p + "[randIndex]];");
                    }
                }

                eval("ssaa_damen_gemischt = ssaa_damen_gemischt.concat(ssaa_damen" + p + ");");
            }
            spieler_spiele_anzahl_array_damen = ssaa_damen_gemischt.slice();

            console.log("Anzahl der Spiele pro Spieler nach Rundenende: ");
            console.log(spieler_spiele_anzahl_array_herren);
            console.log(spieler_spiele_anzahl_array_damen);
            console.log(" \n \n \n");
        }
    }

    function spielplan_ausgeben() {
        document.getElementById("tabellendiv").innerHTML = "<div id='druckbereich'><table border=1 id='spielplantabelle'><tr class='tabhead'><th>Runde</th><th>Platz</th><th>Spiel</th><th>Ergebnis</th></tr>" + tabellenzeilen + "</table></div>";
        document.getElementById("tabellendiv").innerHTML += "<p><button id='drucken' onclick='drucken()'>Tabelle drucken</button></p>";
    }

    function partner_gegner_ausgeben(anzahl) {
        // Partner und Gegner pro Spieler ausgeben
        var spiele_spieler_div = "";
        var alle_spieler_spiele_anzahlen = [];
        for (i=1; i<=anzahl; i++) {
            spiele_spieler_div += "<tr><td>" + eval("spieler" + i) + "</td><td>" + eval("anzahl_spiele_spieler" + i) + "</td><td>" + eval("partner_spieler" + i) + "</td>" + /*"<td>" + eval("gegner_spieler" + i) + "</td>" + */"</tr>";
            alle_spieler_spiele_anzahlen.push(eval("anzahl_spiele_spieler" + i));
        }
        document.getElementById("tabellendiv").innerHTML += "<div id='spieleanzahl'><h3>Auswertung der Spiele pro Spieler: </h3><table border=0 id='auswertungstabelle'><tr><th>Spieler</th><th>Anzahl</th><th>Partner</th><!--<th>Gegner</th>--></tr>" + spiele_spieler_div + "</table></div>";

        // Auf gleich viele Spiele bei jedem Spieler prüfen
        var gleich;
        const areAllElementsEqual = arr => arr.every(element => element === arr[0]);
        if (areAllElementsEqual(alle_spieler_spiele_anzahlen)) {
            gleich = "<br><span id='spiele_gleich' class='spiele_analyse'>Alle haben gleich viele Spiele!</span>";
        }
        else {
            gleich = "<br><span id='spiele_nicht_gleich' class='spiele_analyse'>Nicht alle haben gleich viele Spiele!</span>";
        }

        document.getElementById("spieleanzahl").innerHTML += gleich;
    }


    function erstellen_zusammen() {
        console.clear();

        // Doppelkombinationen erstellen Anfang
        var SA = [];
        n = document.getElementById("eingabe_spieler").value;

        plaetze = document.getElementById("eingabe_plaetze").value;
        if (plaetze > Math.floor(n/4)) {
            alert("Warnung: \nZu wenige Plätze ausgewählt! \n(Pro 4 Spieler 1 Platz)");
            return;
        }

        if (n < 0) {
            n *= -1;
        }
        if (n % 2 != 0) {
            var ungerade = true;
            n++;
        }
        for (i=1; i<=n; i++) {
           var z = parseInt(i);
            SA.push(z);
        }
        var HA = SA.slice();
        // Sa und HA sind Arrays mit den Elementen 1 bis anzahl_spieler

        doppelkombinationen = [];
        for (i=0; i<=(n-2); i++) {
            var a = 0;
            var b = n - 1;
            for (c=1; c<=(n/2); c++) {
                doppelkombinationen.push(String(SA[a]) + "/" + String(SA[b]));
                a++;
                b--;
            }
            SA[1] = HA[n-1];
            x = 2;
            for (y=1; y<=(n-1); y++) {
                SA[x] = HA[y];
                x++;
            }
            HA = SA.slice();
        }
        // doppelkombinatonen ist ein Array, das alle möglichen Kombinationen enthält (Formel: n*(n-1)/2; z.B. 1/2, 3/4, 1/4, 2/3, usw...)
        // Doppelkombinationen erstellen Ende
        // --------------------------------------------------
        // Spielplan erstellen Anfang
        spiele_generieren();
        // das Array spielplan besteht aus allen möglichen Spielen, z.B. 1/8 - 3/6, 2/5 - 4/7 etc.
        // Spielplan erstellen Ende

        // Spiele mit Platzhalter wenn ungerade entfernen
        spielplan = spielplan.filter(a => !a.includes("Platzhalter"));
        if (ungerade == true) {
            spielplan = spielplan.filter(a => !a.includes(n));
        }

        // aus dem Spielplan-Array einen String erstellen, in diesem die Zahlen durch Buchstaben ersetzen, damit es zu keinen Problemen bei der Doppelzahlelement-Entfernung kommt (1, 10, 11 etc.)
        spielplan_string = spielplan.join("\n");
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + alphabet[i-1] + "');");
        }
        if (ungerade == true) {
            n++;
        }
        spielplan = spielplan_string.split("\n");
        // fertig; später werden die Buchstaben wieder zu Zahlen umgeändert

        var doppelzahlelemente = [];
        for (i=1; i<=n; i++) {
            // Array mit den Elementen mit doppelten Zahlen erstellen (z.B. "1/3 - 3/4" bzw. "a/c - c/d")
            spielplan.forEach(function (spiel, index) {
                if (spiel.split(String(alphabet[i-1])).length-1 >= 2) {
                    doppelzahlelemente.push(spielplan[index]);
                }
            });       
        }

        //Elemente mit doppelten Zahlen aus Spielplan-Array entfernen
        spielplan = spielplan.filter(function(element) {
            return !doppelzahlelemente.includes(element);
        });

        // die Buchstaben wieder zu Zahlen umändern, damit es später bei den Ersetzungen durch die Namen nicht zu Fehlern kommt
        spielplan_string = spielplan.join("\n");
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + alphabet[i-1] + "/g, '" + i + "');");
        }
        if (ungerade == true) {
            n++;
        }
        spielplan = spielplan_string.split("\n");
        // jetzt ist alles wieder so als wenn die Zahlen nie zu Buchstaben geändert worden wären

        zufaellig_sortieren(spielplan);     

        // im Ausgabe-String die Zahlen durch Namen ersetzen
        spielplan_string = spielplan.join("\n");
        spieler1 = document.getElementById("spieler1").value;
        if (spieler1 == "") {
            alert("Bitte Spielernamen eintragen!");
            return;
        }    
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spieler" + i + " = document.getElementById('spieler" + i + "').value");
            eval("partner_spieler" + i + " = []");
            eval("gegner_spieler" + i + " = []");
            eval("anzahl_spiele_spieler" + i + " = 0;"); // brauchen wir später für die Rundenerstellung
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + eval("spieler" + i) + "');");
        }

        //inputs_deaktivieren(n);

        spiele_wieder_array();
        
        // Jetzt werden die Runden erstellt
        rundenvorbereitung("zusammen");

        for (r=1; r<=anzahl_runden; r++) {
            // Hintergrundfarbe der Tabelle
            tabelle_hintergrundfarbe();

            eval("runde" + r + " = [];");

            // Spiele pro Runde generieren
            for (x=1; x<=anzahl_spiele_pro_runde; x++) {
                console.log("\n" + x + ". Spiel / Runde " + r + ": \n ");
                spieler_bestimmen("zusammen");
                passendes_spiel_finden_und_speichern(n);
                vorheriges_spiel_auswerten("zusammen", n);
            }
        }
        spielplan_ausgeben();
        partner_gegner_ausgeben(n)
    }

    function erstellen_mixed() {
        console.clear();

        // Doppelkombinationen erstellen Anfang
        var SA = [];
        n = document.getElementById("eingabe_spieler").value;

        plaetze = document.getElementById("eingabe_plaetze").value;
        if (plaetze > Math.floor(n/2)) {
            alert("Warnung: \nZu wenige Plätze ausgewählt! \n(Pro 2 Spieler 1 Platz)");
            return;
        }
        
        doppelkombinationen = [];

        // alle Herren/Damen-Kombinationen erstellen und daraus Array erstellen, mit dem dann der Spielplan erstellt wird
        for (i=1, wh=0; i<=n; i++, wh++) {
            for (u=(n-0+i-wh); u<=(2*n); u++) {
                doppelkombinationen.push(u + "/" + i);
            }
        }
        // Doppelkombinationen erstellen Ende
        // --------------------------------------------------
        // Spielplan erstellen Anfang
        spiele_generieren();
        // das Array spielplan besteht aus allen möglichen Spielen, z.B. 1/8 - 3/6, 2/5 - 4/7 etc.
        // Spielplan erstellen Ende

        // aus dem Spielplan-Array einen String erstellen, in diesem die Zahlen durch Buchstaben ersetzen, damit es zu keinen Problemen bei der Doppelzahlelement-Entfernung kommt (1, 10, 11 etc.)
        spielplan_string = spielplan.join("\n");
        for (i=(2*n); i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + alphabet[i-1] + "');");
        }
        spielplan = spielplan_string.split("\n");
        // fertig; später werden die Buchstaben wieder zu Zahlen umgeändert

        var doppelzahlelemente = [];
        for (i=1; i<=(2*n); i++) {
            // Array mit den Elementen mit doppelten Zahlen erstellen (z.B. "1/3 - 3/4" bzw. "a/c - c/d")
            spielplan.forEach(function (spiel, index) {
                if (spiel.split(String(alphabet[i-1])).length-1 >= 2) {
                    doppelzahlelemente.push(spielplan[index]);
                }
            });       
        }

        //Elemente mit doppelten Zahlen aus Spielplan-Array entfernen
        spielplan = spielplan.filter(function(element) {
            return !doppelzahlelemente.includes(element);
        });

        // die Buchstaben wieder zu Zahlen umändern, damit es später bei den Ersetzungen durch die Namen nicht zu Fehlern kommt
        spielplan_string = spielplan.join("\n");
        for (i=(2*n); i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + alphabet[i-1] + "/g, '" + i + "');");
        }
        spielplan = spielplan_string.split("\n");
        // jetzt ist alles wieder so als wenn die Zahlen nie zu Buchstaben geändert wurden

        zufaellig_sortieren(spielplan);   

        // im Ausgabe-String die Zahlen durch Namen ersetzen
        spielplan_string = spielplan.join("\n");
        spieler1 = document.getElementById("spieler1").value;
        if (spieler1 == "") {
            alert("Bitte Spielernamen eintragen!");
            return;
        }
        for (i=(2*n); i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spieler" + i + " = document.getElementById('spieler" + i + "').value");
            eval("partner_spieler" + i + " = []");
            eval("gegner_spieler" + i + " = []");
            eval("anzahl_spiele_spieler" + i + " = 0;"); // brauchen wir später für die Rundenerstellung
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + eval("spieler" + i) + "');");
        }

        //inputs_deaktivieren(2*n);
        spiele_wieder_array();
           
        // Jetzt werden die Runden erstellt
        rundenvorbereitung("mixed");

        for (r=1; r<=anzahl_runden; r++) {
            // Hintergrundfarbe der Tabelle
            tabelle_hintergrundfarbe();

            eval("runde" + r + " = [];");

            for (x=1; x<=anzahl_spiele_pro_runde; x++) {
                console.log("\n" + x + ". Spiel / Runde " + r + ": \n ");
                spieler_bestimmen("mixed");
                passendes_spiel_finden_und_speichern(2*n);
                vorheriges_spiel_auswerten("mixed", 2*n);
            }
        }
        spielplan_ausgeben();
        partner_gegner_ausgeben(2*n);
    }

    function erstellen() {
        if (document.getElementById("mixed").checked) {
            erstellen_mixed();
        }
        else {
            erstellen_zusammen();
        }
    }

    function spieler_anzeigen() {
        document.getElementById("spielernamen").innerHTML = "";
        var anzahl = document.getElementById("eingabe_spieler").value;
        var alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
        var spielerinputs = "";
        
        if (document.getElementById("mixed").checked) {
            spielerinputs = "<table border=0><tr><th>Herren</th><th>Damen</th></tr>";
            for (i=1; i<=anzahl; i++) {
                spielerinputs += "<tr><td>Spieler " + i + ": <input type='text' value='" + alphabet[i-1] + "' id='spieler" + i + "' class='spielerinputs'></td><td>Spielerin " + i + ": <input type='text' value='" + alphabet[i+(anzahl-1)] + "' id='spieler" + (anzahl-0+i) + "' class='spielerinputs'></td></tr>";   // das muss so blöd gelöst werden weil die Zahlen sonst als String zusammengebaut werden...
            }
            spielerinputs += "</table>";
        }
        else {
            for (i=1; i<=anzahl; i++) {
                spielerinputs += "Spieler " + i + ": <input type='text' value='" + alphabet[i-1] + "' id='spieler" + i + "' class='spielerinputs'><br>";
            }
        }
        
        spielerinputs += "<p><b>Bitte eindeutige Spielernamen verwenden!<br>(heißt z.B. keine Zahlen wie 1, 10, 11 etc.)<br><br>Bei Mixed bitte gleich viele Damen wie Herren eintragen!</p>";
        document.getElementById("spielernamen").innerHTML = spielerinputs;
        document.getElementById("erstellen_button").disabled = false;
    }

    function drucken() {
        var anzahl_tabelleninputs = document.getElementsByClassName("tabelleninput").length;
        var ergebnis_skript = "<script>";
        ergebnis_skript += "alert('Damit die Farben gedruckt werden, beim Druckdialog \"Hintergrundgrafiken\" o.Ä. ankreuzen!');\n";
        for (a=0; a<anzahl_tabelleninputs; a++) {
            eval("var ti_" + (a+1) + " = document.getElementsByClassName('tabelleninput')[" + a + "].value");
            ergebnis_skript += "var erg" + (a+1) + " = '" + eval("ti_" + (a+1)) + "';\n";
            ergebnis_skript += "document.getElementsByClassName('tabelleninput')[" + a + "].value = erg" + (a+1) + ";\n";
        }
        ergebnis_skript += "<\/script>";

        var design = '<style>body {font-family: sans-serif;} #spielplantabelle {border-collapse: collapse;} .tabelleninput {font-size: 12pt;padding=0px;} th, td {padding: 5px;min-width: 150px;text-align: center;} .tabhead {background-color: darkslategray;color: white;} input[type="text"] {width: 10em;}</style>';
        var printContent = document.getElementById("druckbereich");
        var WinPrint = window.open();
        WinPrint.document.write("<h1>Spielplan</h1>" + printContent.innerHTML + design + ergebnis_skript);
        WinPrint.document.close();
        WinPrint.focus();
        WinPrint.print();
        //WinPrint.close();
    }

    function modus() {
        var modus_cb = document.getElementById("mixed");
        if (modus_cb.checked) {
            document.getElementById("spieler_label").innerHTML = "Anzahl der Spieler pro Geschlecht (max. 13): ";
        }
        else {
            document.getElementById("spieler_label").innerHTML = "Anzahl der Spieler (max. 26): ";
        }
        
    }
</script>
    
    <h1>Spielplangenerator Doppelturnier</h1>
    <div id="eingabediv">
        <div id="tipps">
            <b>Tipps: </b>
            <ul>
                <li>Generell <b>mehr Runden auslosen als benötigt</b> werden (zur Sicherheit, falls man am Ende doch mehr Runden möchte oder siehe nächster Punkt)</li>
                <li>Es kann <b>selten</b> vorkommen, dass durch die zufällige Auslosung ein Spieler <b>gleichzeitig auf 2 Plätzen spielen</b> muss. In diesem Fall diese Runde ignorieren und zur nächsten gehen.</li>
                <li>Die Anzahl der Runden <b>ist nicht</b> die Anzahl der Spiele pro Spieler. Es kann <b>je nach Spieler-Plätze-Runden-Verhältnis</b> sein, dass manche Spieler am Ende eines Turnieres 1 Spiel mehr haben als andere. Der Großteil der Spieler hat allerdings gleich viele Spiele.</li>
                <li>Man kann die <b>Ergebnisse direkt in die Tabelle eintragen!</b> <br>(Achtung: Wenn die Seite geschlossen wird, gehen die Ergebnisse verloren!)</li>
                <li>Beim Mixed-Modus bitte <b>gleich viele Damen wie Herren eintragen</b> - anders funktioniert es nicht.</li>
                <li>Doppelte Paarungen werden <b>so gut wie möglich</b> vermieden. Leider kann es je nach Spieler- und Rundenzahlen trotzdem doppelte Paarungen geben.</li>
            </ul>
        </div>
        <br><br>
        <label for="eingabe_runden">Anzahl der Runden:</label>
        <br>
        <input type="number" min=1 value=4 id="eingabe_runden">
        <br><br>
        <label for="eingabe_plaetze">Anzahl der Plätze: </label>
        <br>
        <input type="number" min=1 value=2 id="eingabe_plaetze">
        <br><br>
        <input type="checkbox" id="mixed" onclick="modus()"><label for="mixed">Mixed-Modus</label>
        <br><br>
        <label for="eingabe_spieler" id="spieler_label">Anzahl der Spieler (max. 26): </label>
        <br>
        <input type="number" min=4 value=8 id="eingabe_spieler">
        <button onclick="spieler_anzeigen()">Auswählen</button>
        <br><br>
        <div id="spielernamen"></div>
        <br>
        <button onclick="erstellen()" id="erstellen_button" disabled>Spielplan erstellen</button>
        <br><br>
    </div>
    <div id="tabellendiv"></div>

    <div id="version">
        <span>Version 1.4.1</span>
        <br>
        <span>© Michael Hobel</span>
    </div>

<script>
    
    window.addEventListener('beforeunload', function (e) {
        e.preventDefault();
        e.returnValue = '';
    });
    
</script>
</body>
</html>