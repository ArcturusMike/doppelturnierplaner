<!DOCTYPE html>
<html>
<head>
    <title>Spielplangenerator Doppelturnier Zufall</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
        }
        
        #eingabediv, input, button {
            font-size: 14pt;
        }

        #tabelle {
            border-collapse: collapse;
        }

        th, td {
            padding: 5px;
            min-width: 150px;
            text-align: center;
        }
        
        .rundenbeginn {
            border-top: 2px solid black;
        }

        #version {
            position: fixed;
            right: 5px;
            bottom: 5px;
            font-size: 9pt;
            text-align: right;
        }

        #eingabediv, #tabellendiv {
            float: left;
            margin-right: 200px;
        }
    </style>
</head>
<body>    
<script>
    function erstellen() {
        var alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];

        // Doppelkombinationen erstellen Anfang
        var SA = [];
        var n = document.getElementById("eingabe_spieler").value;

        var plaetze = document.getElementById("eingabe_plaetze").value;
        if (plaetze > Math.floor(n/4)) {
            alert("Warnung: \nZu wenige Plätze ausgewählt! \n(Pro 4 Spieler 1 Platz)");
            return;
        }

        if (n < 0) {
            n *= -1;
        }
        if (n % 2 != 0) {
            var ungerade = true;
            n++;
        }
        for (i=1; i<= n; i++) {
           var z = parseInt(i);
            SA.push(z);
        }
        var HA = SA.slice();


        var doppelkombinationen = [];
        for (i=0; i<=(n-2); i++) {
            var a = 0;
            var b = n - 1;
            for (c=1; c<=(n/2); c++) {
                doppelkombinationen.push(String(SA[a]) + "/" + String(SA[b]));
                a++;
                b--;
            }
            SA[1] = HA[n-1];
            x = 2;
            for (y=1; y<=(n-1); y++) {
                SA[x] = HA[y];
                x++;
            }
            HA = SA.slice();
        }
        // Doppelkombinationen erstellen Ende
        // Spielplan erstellen Anfang
        var SA = doppelkombinationen.slice();
        var m = doppelkombinationen.length;
        if (m < 0) {
            m *= -1;
        }
        if (m % 2 != 0) {
            m++;
            SA.push("Platzhalter");
        }
        var HA = SA.slice();
        var spielplan = [];
        for (i=0; i<=(m-2); i++) {
            var a = 0;
            var b = m - 1;
            for (c=1; c<=(m/2); c++) {
                spielplan.push(SA[a] + " - " + SA[b]);
                a++;
                b--;
            }
            SA[1] = HA[m-1];
            x = 2;
            for (y=1; y<=(m-1); y++) {
                SA[x] = HA[y];
                x++;
            }
            HA = SA.slice();
        }
        // Spielplan erstellen Ende

        // Spiele mit Platzhalter wenn ungerade entfernen
        spielplan = spielplan.filter(a => !a.includes("Platzhalter"));
        if (ungerade == true) {
            spielplan = spielplan.filter(a => !a.includes(n));
        }


        // aus dem Spielplan-Array einen String erstellen, in diesem die Zahlen durch Buchstaben ersetzen, damit es zu keinen Problemen bei der Doppelzahlelement-Entfernung kommt (1, 10, 11 etc.)
        var spielplan_string = spielplan.join("\n");
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + alphabet[i-1] + "');");
        }
        if (ungerade == true) {
            n++;
        }
        spielplan = spielplan_string.split("\n");
        // fertig; später werden die Buchstaben wieder zu Zahlen umgeändert

        var doppelzahlelemente = [];
        for (i=1; i<=n; i++) {
            // Array mit den Elementen mit doppelten Zahlen erstellen (z.B. "1/3 - 3/4" bzw. "a/c - c/d")
            spielplan.forEach(function (spiel, index) {
                if (spiel.split(String(alphabet[i-1])).length-1 >= 2) {
                    doppelzahlelemente.push(spielplan[index]);
                }
            });       
        }

        //Elemente mit doppelten Zahlen aus Spielplan-Array entfernen
        spielplan = spielplan.filter(function(element) {
            return !doppelzahlelemente.includes(element);
        });

        // die Buchstaben wieder zu Zahlen umändern, damit es später bei den Ersetzungen durch die Namen nicht zu Fehlern kommt
        spielplan_string = spielplan.join("\n");
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("spielplan_string = spielplan_string.replace(/" + alphabet[i-1] + "/g, '" + i + "');");
        }
        if (ungerade == true) {
            n++;
        }
        spielplan = spielplan_string.split("\n");
        // jetzt ist alles wieder so als wenn die Zahlen nie zu Buchstaben geändert wurden

        // Spielplan-Array 5 Mal zufällig sortieren nach Fisher-Yates-Shuffle
        for (i=0; i<5; i++) {
            var sl = spielplan.length;
            while (--sl > 0) {
                var randIndex = Math.floor(Math.random() * (sl + 1));
                [spielplan[randIndex], spielplan[sl]] = [spielplan[sl], spielplan[randIndex]];
            }
        }
                

        // im Ausgabe-String die Zahlen durch Namen ersetzen
        spielplan_string = spielplan.join("\n");
        var spieler1 = document.getElementById("spieler1").value;
        if (spieler1 == "") {
            alert("Bitte Spielernamen eintragen!");
            return;
        }    
        if (ungerade == true) {
            n--;
        }
        for (i=n; i>0; i--) { // minus statt plus weil sonst 1 den 10er ersetzt
            eval("var spieler" + i + " = document.getElementById('spieler" + i + "').value");
            eval("var anzahl_spiele_spieler" + i + " = 0;"); // brauchen wir später für die Rundenerstellung
            eval("spielplan_string = spielplan_string.replace(/" + i + "/g, '" + eval("spieler" + i) + "');");
        }
        
        document.getElementById("erstellen_button").disabled = true;

        // den String wieder zum Array machen, nur dass diesmal die Namen drin stehen statt den Anfangszahlen
        spielplan = spielplan_string.split("\n");
           

        // Jetzt werden die Runden erstellt

        var spielplan_rest = spielplan.slice();

        console.clear()

        var anzahl_spiele_pro_runde = plaetze;
        var tabellenzeilen = "";

        // Je ein Array für alle Runden erstellen
        var anzahl_runden = document.getElementById("eingabe_runden").value;
        var spieler_spiele_anzahl_array;
        for (r=1; r<=anzahl_runden; r++) {
            // Hintergrundfarbe der Tabelle
            if (r % 2) {
                var hintergrundfarbe = "lightgray";
            }
            else {
                var hintergrundfarbe = "white";
            }

            eval("var runde" + r + " = [];");
        
            // Für Spiel 1 das erste Element des Spielplans nehmen
            eval("runde" + r + "[0] = spielplan_rest.shift();");
            console.log("Spiel 1/Runde " + r + ": \n" + eval("runde" + r));
            //console.log("Restlicher Spielplan: \n" + spielplan_rest);
            
            tabellenzeilen += "<tr style='background-color: " + hintergrundfarbe + "' class=''><td>Runde " + r + "</td><td>Platz 1</td><td>" + eval("runde" + r + "[0]") + "</td><td></td></tr>";

            // ab der 2. Runde soll auch gleich zu Beginn der Schleife die letzte Parte der vorigen Runde gecheckt werden, welche Spieler dort gespielt haben. Sonst stimmt die Gesamtanzahl der Spiele nie...
            if (r >= 2) {
                for (i=n; i>0; i--) {
                    if (eval("runde" + (r-1) + "[runde" + (r-1) + ".length-1].includes(spieler" + i + ")")) {
                        eval("anzahl_spiele_spieler" + i + "++;");
                    }
                }
            }
            for (x=1; x<anzahl_spiele_pro_runde; x++) {
                console.log("\n" + x + ". Durchlauf: \n ");
                // Spieler des ersten Spieles bestimmen, deren Spielanzahl um 1 erhöhen und alle Spieler samt deren Spielanzahl in ein Objekt-Array packen
                spieler_spiele_anzahl_array = [];
                for (i=n; i>0; i--) {
                    if (eval("runde" + r + "[runde" + r + ".length-1].includes(spieler" + i + ")")) {
                        eval("anzahl_spiele_spieler" + i + "++;");
                    }

                    eval("spieler_spiele_anzahl_array.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
                }

                // das Array der Spieler mit den jeweiligen Anzahlen der Spielen wird nach der Spielanzahl sortiert (damit später die Paarungen mit den wenigsten Spielen gefunden werden können)
                spieler_spiele_anzahl_array.sort(function(obj1, obj2) {
                    return obj1.anzahl_spiele - obj2.anzahl_spiele;
                });
                console.log("sortiert: ");
                console.log(spieler_spiele_anzahl_array);

                // die Spieler für das nächste Spiel werden festgelegt
                var next_player_1 = spieler_spiele_anzahl_array[0].spieler;
                var next_player_2 = spieler_spiele_anzahl_array[1].spieler;
                var next_player_3 = spieler_spiele_anzahl_array[2].spieler;
                var next_player_4 = spieler_spiele_anzahl_array[3].spieler;
                console.log("Nächste Spieler: " + next_player_1 + " " + next_player_2 + " " + next_player_3 + " " + next_player_4);

                // das erste Spiel im restlichen Spielplan finden & festlegen, in dem die 4 Spieler mit den wenigsten Spielen vorkommen
                var next_match_index = spielplan_rest.findIndex(function(matchindex) {
                    if (matchindex.includes(next_player_1)) {
                        if (matchindex.includes(next_player_2)) {
                            if (matchindex.includes(next_player_3)) {
                                if (matchindex.includes(next_player_4)) {
                                    return matchindex;
                                }
                            }
                        }
                    }
                });
                var next_match = spielplan_rest[next_match_index];
                eval("runde" + r + ".push(next_match)");
                spielplan_rest.splice(next_match_index, 1);
                
                console.log("Nächster Matchindex: " + next_match_index);
                console.log("Nächstes Match: " + next_match);
                console.log("Rundenspielplan: " + eval("runde" + r));
                console.log(" \n \n \n");

                tabellenzeilen += "<tr style='background-color: " + hintergrundfarbe + "'><td>Runde " + r + "</td><td>Platz " + (x+1) + "</td><td>" + eval("runde" + r + "[x]") + "</td><td></td></tr>";
            }
            
            document.getElementById("tabellendiv").innerHTML = "<table border=1 id='tabelle'><tr><th>Runde</th><th>Platz</th><th>Spiel</th><th>Ergebnis</th></tr>" + tabellenzeilen + "</table>";
        }

        // alle Spiele pro Spieler werden nochmals berechnet und zusammengefasst
        var summe_aller_spiele = 0;
        spieler_spiele_anzahl_array = [];
        for (i=n; i>0; i--) {
            if (eval("runde" + anzahl_runden + "[runde" + anzahl_runden + ".length-1].includes(spieler" + i + ")")) {
                eval("anzahl_spiele_spieler" + i + "++;");
            }

            summe_aller_spiele += eval("anzahl_spiele_spieler" + i);
            eval("spieler_spiele_anzahl_array.unshift({spieler: spieler" + i + ", anzahl_spiele: anzahl_spiele_spieler" + i + "});");
            
        }
        console.log(spieler_spiele_anzahl_array);
        console.log(summe_aller_spiele);
}

    function spieler_anzeigen() {
        document.getElementById("spielernamen").innerHTML = "";
        var anzahl = document.getElementById("eingabe_spieler").value;
        var alphabet = ["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"];
        for (i=1; i<=anzahl; i++) {
            document.getElementById("spielernamen").innerHTML += "Spieler " + i + ": <input type='text' value='" + alphabet[i-1] + "' id='spieler" + i + "'><br>";
        }
        document.getElementById("spielernamen").innerHTML += "<p><b>Bitte eindeutige Spielernamen verwenden!<br>(heißt z.B. keine Zahlen wie 1, 10, 11 etc.)</b></p>";
        document.getElementById("erstellen_button").disabled = false;
    }

</script>
    
    <h1>Spielplangenerator Doppelturnier Zufall</h1>
    <div id="eingabediv">
        <label for="eingabe_runden">Anzahl der Runden: </label>
        <br>
        <input type="number" min=1 value=1 id="eingabe_runden">
        <br><br>
        <label for="eingabe_plaetze">Anzahl der Plätze: </label>
        <br>
        <input type="number" min=1 value=1 id="eingabe_plaetze">
        <br><br>
        <label for="eingabe_spieler">Anzahl der Spieler (max. 26): </label>
        <br>
        <input type="number" min=4 value=4 id="eingabe_spieler">
        <button onclick="spieler_anzeigen()">Auswählen</button>
        <br><br>
        <div id="spielernamen"></div>
        <br>
        <button onclick="erstellen()" id="erstellen_button" disabled>Spielplan erstellen</button>
        <br><br>
    </div>
    <div id="tabellendiv"></div>

    <div id="version">
        <span>Version 1.0</span>
        <br>
        <span>© Michael Hobel, Vereinsmeister 2022 &#127934;</span>
    </div>

    



</body>
</html>